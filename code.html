
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Request Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 40px;
        }

        .table-container {
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .table-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f1f3f4;
            font-weight: 600;
            color: #2c3e50;
        }

        .view-request {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .view-request:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fff;
            margin: 2% auto;
            padding: 0;
            border-radius: 15px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 25px;
            position: relative;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h2 {
            font-size: 1.8rem;
            margin: 0;
        }

        .close {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 30px;
        }

        .modal-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .modal-section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 3px solid #3498db;
            display: inline-block;
        }

        .modal-details-table {
            width: 100%;
            margin-bottom: 25px;
        }

        .modal-details-table td {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .modal-label {
            font-weight: 600;
            color: #2c3e50;
            width: 40%;
            vertical-align: top;
        }

        .modal-value {
            color: #34495e;
            word-wrap: break-word;
        }

        .modal-details-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .modal-details-table tr:hover {
            background: #f8f9fa;
        }

        .modal-actions {
            padding: 25px 30px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            background: #f8f9fa;
            border-radius: 0 0 15px 15px;
        }

        .modal-actions button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .modal-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* PDF Specific Styles */
        .pdf-content {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
        }

        .pdf-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #3498db;
        }

        .pdf-header h1 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .pdf-section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }

        .pdf-section-title {
            background: #3498db;
            color: white;
            padding: 12px 20px;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .pdf-table td {
            padding: 10px 15px;
            border: 1px solid #ddd;
            vertical-align: top;
        }

        .pdf-table .label {
            background: #f8f9fa;
            font-weight: 600;
            width: 35%;
            color: #2c3e50;
        }

        .pdf-table .value {
            background: white;
            color: #34495e;
        }

        .pdf-materials-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .pdf-materials-table th {
            background: #34495e;
            color: white;
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .pdf-materials-table td {
            padding: 10px 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .pdf-materials-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .modal-columns {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .modal-content {
                width: 98%;
                margin: 1% auto;
            }
            
            .modal-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>Event Request Management</h1>
            <p>Comprehensive event planning and approval system</p>
        </div>

        <div class="content">
            <!-- Pending Requests Table -->
            <div class="table-container">
                <div class="table-header">Pending Requests</div>
                <table>
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Date</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Annual Tech Conference</td>
                            <td>2024-03-15</td>
                            <td>Convention Center</td>
                            <td><span style="color: #f39c12; font-weight: 600;">Pending</span></td>
                            <td>
                                <button class="view-request" data-request='{"event_form_id":1,"event_name":"Annual Tech Conference","event_title":"Technology Innovation Summit","event_date":"2024-03-15","sender_email":"organizer@techconf.com","date_time_ingress":"2024-03-15 08:00:00","date_time_egress":"2024-03-15 18:00:00","place":"Main Hall","location":"Convention Center Downtown","sponsorship_budg":"$50,000","target_audience":"Tech Professionals","number_audience":"500","set_up":"Full stage setup","booth_size":"10x10 feet","booth_inclusion":"Power, internet, tables","number_tables":"5","number_chairs":"20","speaking_slot":"Keynote Speaker","date_time":"2024-03-15 10:00:00","program_target":"Industry Leaders","technical_team":"Required","trainer_needed":"Yes","ready_to_use":"No","provide_materials":"Yes","created_at":"2024-01-15 10:30:00","request_status":"Pending"}' data-materials='[{"Brochure":{"name":"Tech Innovation Guide","qty":"500"},"Swag":{"name":"Branded T-shirts","qty":"200"},"Marketing Material":{"name":"Digital Banners","qty":"10"}}]'>View Details</button>
                            </td>
                        </tr>
                        <tr>
                            <td>Product Launch Event</td>
                            <td>2024-04-20</td>
                            <td>Corporate Headquarters</td>
                            <td><span style="color: #f39c12; font-weight: 600;">Pending</span></td>
                            <td>
                                <button class="view-request" data-request='{"event_form_id":2,"event_name":"Product Launch Event","event_title":"Revolutionary Product Unveiling","event_date":"2024-04-20","sender_email":"marketing@company.com","date_time_ingress":"2024-04-20 14:00:00","date_time_egress":"2024-04-20 20:00:00","place":"Auditorium","location":"Corporate Headquarters","sponsorship_budg":"$30,000","target_audience":"Media and Investors","number_audience":"150","set_up":"Presentation setup","booth_size":"8x8 feet","booth_inclusion":"Audio/Visual equipment","number_tables":"3","number_chairs":"150","speaking_slot":"Product Demo","date_time":"2024-04-20 16:00:00","program_target":"Key Stakeholders","technical_team":"Required","trainer_needed":"No","ready_to_use":"Yes","provide_materials":"Yes","created_at":"2024-01-20 14:15:00","request_status":"Pending"}' data-materials='[{"Brochure":{"name":"Product Catalog","qty":"200"},"Swag":{"name":"USB Drives","qty":"100"},"Marketing Material":{"name":"Press Kits","qty":"50"}}]'>View Details</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Request History Table -->
            <div class="table-container">
                <div class="table-header">Request History</div>
                <table>
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Processed</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Winter Workshop Series</td>
                            <td>2024-02-10</td>
                            <td><span style="color: #27ae60; font-weight: 600;">Approved</span></td>
                            <td>2024-01-25 09:30:00</td>
                            <td>
                                <button class="view-request" data-request='{"event_form_id":3,"event_name":"Winter Workshop Series","event_title":"Professional Development Workshops","event_date":"2024-02-10","sender_email":"hr@company.com","date_time_ingress":"2024-02-10 09:00:00","date_time_egress":"2024-02-10 17:00:00","place":"Training Rooms","location":"Office Building","sponsorship_budg":"$15,000","target_audience":"Employees","number_audience":"100","set_up":"Workshop setup","booth_size":"6x6 feet","booth_inclusion":"Whiteboards, projectors","number_tables":"10","number_chairs":"100","speaking_slot":"Training Sessions","date_time":"2024-02-10 10:00:00","program_target":"All Staff","technical_team":"Not Required","trainer_needed":"Yes","ready_to_use":"Yes","provide_materials":"No","created_at":"2024-01-10 11:00:00","request_status":"Approved"}' data-materials='[{"Brochure":{"name":"Training Materials","qty":"100"},"Swag":{"name":"Notebooks","qty":"100"},"Marketing Material":{"name":"Posters","qty":"5"}}]'>View Details</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="requestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Event Request Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-columns">
                    <div id="modalLeft"></div>
                    <div id="modalRight"></div>
                </div>
            </div>
            <div class="modal-actions" id="modalActions"></div>
        </div>
    </div>

    <script>
        // Modal rendering logic with improved PDF structure
        function renderModal(data, materials, isPending) {
            // Group fields by section
            const sections = [
                {
                    title: "Event Details",
                    fields: [
                        {label: "Event Name", key: "event_name"},
                        {label: "Event Title", key: "event_title"},
                        {label: "Event Date", key: "event_date"},
                        {label: "Sender Email", key: "sender_email"},
                        {label: "Date Time Ingress", key: "date_time_ingress"},
                        {label: "Date Time Egress", key: "date_time_egress"},
                        {label: "Place", key: "place"},
                        {label: "Location", key: "location"}
                    ]
                },
                {
                    title: "Budgeting & Audience",
                    fields: [
                        {label: "Sponsorship Budget", key: "sponsorship_budg"},
                        {label: "Target Audience", key: "target_audience"},
                        {label: "Number Audience", key: "number_audience"}
                    ]
                },
                {
                    title: "Booth & Other Setup",
                    fields: [
                        {label: "Set Up", key: "set_up"},
                        {label: "Booth Size", key: "booth_size"},
                        {label: "Booth Inclusion", key: "booth_inclusion"},
                        {label: "Number Tables", key: "number_tables"},
                        {label: "Number Chairs", key: "number_chairs"},
                    ]
                },
                {
                    title: "Programs & Marketing",
                    fields: [
                        {label: "Speaking Slot", key: "speaking_slot"},
                        {label: "Date Time", key: "date_time"},
                        {label: "Program Target", key: "program_target"},
                        {label: "Technical Team", key: "technical_team"},
                        {label: "Trainer Needed", key: "trainer_needed"},
                        {label: "Ready To Use", key: "ready_to_use"},
                        {label: "Provide Materials", key: "provide_materials"}
                    ]
                }
            ];
            
            const extraFields = [
                {label: "Event Form Id", key: "event_form_id"},
                {label: "Created At", key: "created_at"},
                {label: "Request Status", key: "request_status"}
            ];

            let leftHtml = '';
            sections.forEach(section => {
                leftHtml += `<div class="modal-section-title">${section.title}</div><table class="modal-details-table">`;
                section.fields.forEach(f => {
                    if (data[f.key] !== undefined) {
                        leftHtml += `<tr><td class="modal-label">${f.label}:</td><td class="modal-value">${data[f.key]||''}</td></tr>`;
                    }
                });
                leftHtml += '</table>';
            });
            document.getElementById('modalLeft').innerHTML = leftHtml;

            let rightHtml = '';
            rightHtml += '<div class="modal-section-title">Status & Meta Info</div><table class="modal-details-table">';
            extraFields.forEach(f => {
                if (data[f.key] !== undefined) {
                    rightHtml += `<tr><td class="modal-label">${f.label}:</td><td class="modal-value">${data[f.key]||''}</td></tr>`;
                }
            });
            rightHtml += '</table>';
            
            if (materials && materials.length > 0) {
                rightHtml += '<div class="modal-section-title" style="margin-top:18px;">Requested Materials</div>';
                rightHtml += '<table class="modal-details-table"><tr><th>Category</th><th>Name</th><th>Quantity</th></tr>';
                materials.forEach(mat => {
                    ['Brochure','Swag','Marketing Material'].forEach(type => {
                        if (mat[type] && mat[type].name && mat[type].qty) {
                            rightHtml += `<tr><td>${type}</td><td>${mat[type].name}</td><td>${mat[type].qty}</td></tr>`;
                        }
                    });
                });
                rightHtml += '</table>';
            }
            document.getElementById('modalRight').innerHTML = rightHtml;

            let actions = '';
            if (isPending) {
                actions += `<button onclick="updateStatus(${data.event_form_id},'Approved')" style="background:#2563eb; color: white;">Approve</button>`;
                actions += `<button onclick="updateStatus(${data.event_form_id},'Declined')" style="background:#e53e3e; color: white;">Decline</button>`;
            } else {
                actions += `<button onclick="downloadRequestPDF()" style="background:#2563eb; color: white;">Download PDF</button>`;
            }
            document.getElementById('modalActions').innerHTML = actions;
            document.getElementById('requestModal').style.display = 'block';
            document.getElementById('requestModal').setAttribute('data-id', data.event_form_id);
            
            // Store data globally for PDF generation
            window.currentModalData = data;
            window.currentModalMaterials = materials;
        }

        // Event delegation for view-request buttons
        document.body.addEventListener('click', function(e) {
            if (e.target.classList.contains('view-request')) {
                e.preventDefault();
                let data = JSON.parse(e.target.getAttribute('data-request'));
                let materials = [];
                try { 
                    materials = JSON.parse(e.target.getAttribute('data-materials')); 
                } catch(error) {
                    console.log('Error parsing materials:', error);
                }
                renderModal(data, materials, data.request_status === 'Pending');
            }
        });

        function closeModal() {
            document.getElementById('requestModal').style.display = 'none';
        }

        // Improved PDF generation function
        function downloadRequestPDF() {
            const data = window.currentModalData;
            const materials = window.currentModalMaterials;
            
            if (!data) {
                alert('No data available for PDF generation');
                return;
            }

            // Create a comprehensive PDF structure
            const pdfContent = createPDFContent(data, materials);
            
            // Create a temporary container for PDF generation
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = pdfContent;
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.top = '-9999px';
            tempDiv.style.width = '210mm'; // A4 width
            tempDiv.className = 'pdf-content';
            document.body.appendChild(tempDiv);

            const opt = {
                margin: [0.5, 0.5, 0.5, 0.5],
                filename: `event_request_${data.event_form_id || 'details'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                },
                jsPDF: { 
                    unit: 'in', 
                    format: 'a4', 
                    orientation: 'portrait' 
                },
                pagebreak: { 
                    mode: ['css', 'legacy'],
                    before: '.pdf-page-break'
                }
            };

            html2pdf().set(opt).from(tempDiv).save().then(() => {
                // Clean up temporary element
                document.body.removeChild(tempDiv);
            }).catch((error) => {
                console.error('PDF generation failed:', error);
                document.body.removeChild(tempDiv);
                alert('PDF generation failed. Please try again.');
            });
        }

        function createPDFContent(data, materials) {
            const sections = [
                {
                    title: "Event Details",
                    fields: [
                        {label: "Event Name", key: "event_name"},
                        {label: "Event Title", key: "event_title"},
                        {label: "Event Date", key: "event_date"},
                        {label: "Sender Email", key: "sender_email"},
                        {label: "Date Time Ingress", key: "date_time_ingress"},
                        {label: "Date Time Egress", key: "date_time_egress"},
                        {label: "Place", key: "place"},
                        {label: "Location", key: "location"}
                    ]
                },
                {
                    title: "Budgeting & Audience",
                    fields: [
                        {label: "Sponsorship Budget", key: "sponsorship_budg"},
                        {label: "Target Audience", key: "target_audience"},
                        {label: "Number Audience", key: "number_audience"}
                    ]
                },
                {
                    title: "Booth & Other Setup",
                    fields: [
                        {label: "Set Up", key: "set_up"},
                        {label: "Booth Size", key: "booth_size"},
                        {label: "Booth Inclusion", key: "booth_inclusion"},
                        {label: "Number Tables", key: "number_tables"},
                        {label: "Number Chairs", key: "number_chairs"}
                    ]
                },
                {
                    title: "Programs & Marketing",
                    fields: [
                        {label: "Speaking Slot", key: "speaking_slot"},
                        {label: "Date Time", key: "date_time"},
                        {label: "Program Target", key: "program_target"},
                        {label: "Technical Team", key: "technical_team"},
                        {label: "Trainer Needed", key: "trainer_needed"},
                        {label: "Ready To Use", key: "ready_to_use"},
                        {label: "Provide Materials", key: "provide_materials"}
                    ]
                }
            ];

            let pdfHtml = `
                <div class="pdf-content">
                    <div class="pdf-header">
                        <h1>Event Request Details</h1>
                        <p>Request ID: ${data.event_form_id || 'N/A'}</p>
                        <p>Generated on: ${new Date().toLocaleDateString()}</p>
                    </div>
            `;

            // Add all sections
            sections.forEach(section => {
                pdfHtml += `<div class="pdf-section">`;
                pdfHtml += `<div class="pdf-section-title">${section.title}</div>`;
                pdfHtml += `<table class="pdf-table">`;
                
                section.fields.forEach(field => {
                    if (data[field.key] !== undefined && data[field.key] !== '') {
                        pdfHtml += `
                            <tr>
                                <td class="label">${field.label}</td>
                                <td class="value">${data[field.key] || 'N/A'}</td>
                            </tr>
                        `;
                    }
                });
                
                pdfHtml += `</table></div>`;
            });

            // Add status information
            pdfHtml += `
                <div class="pdf-section">
                    <div class="pdf-section-title">Status & Meta Information</div>
                    <table class="pdf-table">
                        <tr><td class="label">Request Status</td><td class="value">${data.request_status || 'N/A'}</td></tr>
                        <tr><td class="label">Created At</td><td class="value">${data.created_at || 'N/A'}</td></tr>
                    </table>
                </div>
            `;

            // Add materials if available
            if (materials && materials.length > 0) {
                pdfHtml += `
                    <div class="pdf-section">
                        <div class="pdf-section-title">Requested Materials</div>
                        <table class="pdf-materials-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Material Name</th>
                                    <th>Quantity</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                materials.forEach(mat => {
                    ['Brochure', 'Swag', 'Marketing Material'].forEach(type => {
                        if (mat[type] && mat[type].name && mat[type].qty) {
                            pdfHtml += `
                                <tr>
                                    <td>${type}</td>
                                    <td>${mat[type].name}</td>
                                    <td>${mat[type].qty}</td>
                                </tr>
                            `;
                        }
                    });
                });
                
                pdfHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            pdfHtml += `</div>`;
            return pdfHtml;
        }

        // Mock functions for demo
        function updateStatus(id, status) {
            alert(`Status updated to: ${status} for request ID: ${id}`);
            closeModal();
        }

        window.onclick = function(event) {
            let modal = document.getElementById('requestModal');
            if (event.target == modal) closeModal();
        }

        // Initialize demo data
        window.currentModalData = null;
        window.currentModalMaterials = null;
    </script>
</body>
</html>

